<style>
ul.nestedmenu {margin-left: 0;}
ul.nestedmenu li {list-style: none;}
ul.nestedmenu li > ul {display: none;}
ul.nestedmenu li > a::before {content: "•"; display: inline-block; margin-right: 0.25rem; width: 0.5rem; text-align: center;}
ul.nestedmenu li.haschildren > a::before {content: "›";}
ul.nestedmenu li.haschildren.active > a::before {transform: rotate(90deg);}
ul.nestedmenu li.active > ul {display: block;}
ul.nestedmenu li > a {color: #444444!important;}
ul.nestedmenu li.active > a {color: rgb(247, 44, 114)!important;}
</style>

{{ $sectionname := .Section }}
{{ $sectionnamesingular := singularize .Section }}
{{ $parentitem := index .Params (print "parent_" $sectionnamesingular) }}

{{ $.Scratch.Set "activeitems" .File.BaseFileName }}
{{ if $parentitem }}
    {{ $.Scratch.Add "activeitems" (print " " $parentitem) }}
    {{ with .Site.GetPage (print "/" $sectionname "/" $parentitem ".md") }}
        {{ $parentitem := index .Params (print "parent_" $sectionnamesingular) }}
        {{ if $parentitem }}
            {{ $.Scratch.Add "activeitems" (print " " $parentitem) }}
        {{ end }}
    {{ end }}
{{ end }}
{{ $activeitems := split ($.Scratch.Get "activeitems") " " }}

{{ with .Site.GetPage (print "/" $sectionname) }}

    {{ $regularpages := .RegularPages.ByTitle }}

    {{ $.Scratch.Set "haschildren" "" }}
    {{ range where $regularpages (print "Params.parent_" $sectionnamesingular) "!=" nil }}
        {{ $parentitem := index .Params (print "parent_" $sectionnamesingular) }}
        {{ if in ($.Scratch.Get "haschildren") $parentitem }}{{ else }}
            {{ $.Scratch.Add "haschildren" (print " " $parentitem) }}
        {{ end }}
    {{ end }}
    {{ $haschildren := split ($.Scratch.Get "haschildren") " " }}

    <ul class="nestedmenu">
    {{ range where $regularpages (print "Params.parent_" $sectionnamesingular) nil }}
        <li class="{{ if in $activeitems .File.BaseFileName }}active{{ end }} {{ if in $haschildren .File.BaseFileName }}haschildren{{ end }}"><a href="{{ .RelPermalink }}">{{ .Title }}</a>
            <ul>
            {{ range where $regularpages (print "Params.parent_" $sectionnamesingular) .File.BaseFileName }}
                <li class="{{ if in $activeitems .File.BaseFileName }}active{{ end }} {{ if in $haschildren .File.BaseFileName }}haschildren{{ end }}"><a href="{{ .RelPermalink }}">{{ .Title }}</a>
                    <ul>
                        {{ range where $regularpages (print "Params.parent_" $sectionnamesingular) .File.BaseFileName }}
                            <li class="{{ if in $activeitems .File.BaseFileName }}active{{ end }} {{ if in $haschildren .File.BaseFileName }}haschildren{{ end }}"><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
                        {{ end }}
                    </ul>
                </li>
            {{ end }}
            </ul>
        </li>
    {{ end }}
    </ul>

{{ end }}